{% extends 'base.html' %}

{% block title %}Каталог{% endblock %}

{% block content %}
<div class="container mt-4">
    <h2>Каталог товаров</h2>
    <div id="cart-message" class="alert alert-success d-none"></div>

    <!-- Стили для единообразного размера карточек и картинок -->
    <style>
    /* Фиксируем высоту изображения и обрезаем края (object-fit: cover). */
    .fixed-img {
        width: 100%;
        height: 200px; /* можно изменить высоту по желанию */
        object-fit: cover;
    }
    /* Если хотите, чтобы и вся карточка имела единый размер, можно задать min-height.
       Но обычно достаточно выровнять только изображения. */
    </style>

    <div class="row">
        {% for product in products %}
        <div class="col-md-4 d-flex align-items-stretch">
            <div class="card mb-4 w-100">
                {% if product.image %}
                <img src="{{ product.image.url }}" class="card-img-top fixed-img" alt="{{ product.name }}">
                {% else %}
                <img src="https://via.placeholder.com/300x200" class="card-img-top fixed-img" alt="{{ product.name }}">
                {% endif %}
                <div class="card-body d-flex flex-column">
                    <h5 class="card-title">{{ product.name }}</h5>
                    <p class="card-text">{{ product.price }} руб.</p>

                    <!-- Блок с кнопками +/− -->
                    <div class="input-group mb-3" style="max-width: 200px;">
                        <button
                            type="button"
                            class="btn btn-outline-secondary btn-lg"
                            onclick="decrementCatalogQuantity('{{ product.id }}')"
                        >−</button>
                        <input
                            type="number"
                            id="catalog-quantity-{{ product.id }}"
                            value="1"
                            min="1"
                            class="form-control text-center"
                            style="max-width: 70px; font-size: 1.2em;"
                        >
                        <button
                            type="button"
                            class="btn btn-outline-secondary btn-lg"
                            onclick="incrementCatalogQuantity('{{ product.id }}')"
                        >+</button>
                    </div>

                    <!-- Кнопка добавления в корзину -->
                    <button class="btn btn-primary mt-auto add-to-cart" data-product-id="{{ product.id }}">
                        Добавить в корзину
                    </button>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", function() {
    // Навешиваем обработчики на кнопки "Добавить в корзину"
    document.querySelectorAll(".add-to-cart").forEach(button => {
        button.addEventListener("click", function(event) {
            event.preventDefault();
            let productId = this.dataset.productId;
            // Получаем выбранное количество
            let quantityInput = document.getElementById("catalog-quantity-" + productId);
            let quantity = quantityInput ? parseInt(quantityInput.value) : 1;
            if (isNaN(quantity) || quantity < 1) {
                quantity = 1;
            }
            // Формируем URL и отправляем запрос
            let addToCartUrl = `/add_to_cart/${productId}/${quantity}/`;
            fetch(addToCartUrl, {
                method: "GET",
                headers: { "X-Requested-With": "XMLHttpRequest" }
            })
            .then(response => response.json())
            .then(data => {
                if (data.message) {
                    alert(data.message);
                }
                let cartBadge = document.getElementById("cart-count");
                if (cartBadge) {
                    cartBadge.textContent = data.cart_count;
                    cartBadge.style.display = data.cart_count > 0 ? "inline-block" : "none";
                }
            })
            .catch(error => console.error("Ошибка при добавлении в корзину:", error));
        });
    });
});

// Увеличение количества
function incrementCatalogQuantity(productId) {
    let input = document.getElementById("catalog-quantity-" + productId);
    if (input) {
        let currentVal = parseInt(input.value) || 1;
        input.value = currentVal + 1;
    }
}

// Уменьшение количества
function decrementCatalogQuantity(productId) {
    let input = document.getElementById("catalog-quantity-" + productId);
    if (input) {
        let currentVal = parseInt(input.value) || 1;
        if (currentVal > 1) {
            input.value = currentVal - 1;
        } else {
            input.value = 1;
        }
    }
}
</script>
{% endblock %}
